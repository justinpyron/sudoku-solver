name: Build and Deploy

on:
  workflow_dispatch:

env:
  GAR_LOCATION: ${{ vars.GAR_LOCATION }}
  GCP_PROJECT_ID: ${{ vars.GCP_PROJECT_ID }}
  GAR_REPOSITORY: ${{ vars.GAR_REPOSITORY }}
  IMAGE_NAME: ${{ vars.IMAGE_NAME }}
  CLOUD_RUN_SERVICE: ${{ vars.CLOUD_RUN_SERVICE }}

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      # Step 1: Check out repository code
      - name: Checkout repository
        uses: actions/checkout@v4

      # Step 2: Set up Python environment
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      # Step 3: Install uv package manager
      - name: Install uv
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH

      # Step 4: Export dependencies to requirements.txt
      - name: Export requirements from uv
        run: |
          uv export --no-dev --no-hashes --output-file requirements.txt
          echo "Generated requirements.txt:"
          cat requirements.txt

      # Step 5: Authenticate to Google Cloud
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      # Step 6: Set up Cloud SDK
      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      # Step 7: Configure Docker to use Artifact Registry
      - name: Configure Docker for Artifact Registry
        run: gcloud auth configure-docker ${{ env.GAR_LOCATION }}-docker.pkg.dev --quiet

      # Step 8: Generate Docker image tags (outputs full image references, not just tag names)
      # Example output: us-central1-docker.pkg.dev/PROJECT/REPO/IMAGE:TAG
      # Creates 3 tags:
      #   1. Commit SHA (e.g., main-abc123) - for pinning to specific commits
      #   2. Branch name (e.g., main) - tracks latest build on branch
      #   3. 'latest' tag - only on default branch
      - name: Extract metadata for Docker
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.GAR_LOCATION }}-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/${{ env.GAR_REPOSITORY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=sha,prefix={{branch}}-
            type=ref,event=branch
            type=raw,value=latest,enable={{is_default_branch}}

      # Step 9: Build and push Docker image to Artifact Registry
      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}

      # Step 10: Deploy to Cloud Run
      - name: Deploy to Cloud Run
        uses: google-github-actions/deploy-cloudrun@v2
        with:
          service: ${{ env.CLOUD_RUN_SERVICE }}
          region: ${{ env.GAR_LOCATION }}
          image: ${{ env.GAR_LOCATION }}-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/${{ env.GAR_REPOSITORY }}/${{ env.IMAGE_NAME }}:latest
          flags: |
            --port=8080
            --memory=512Mi
            --cpu=1
            --min-instances=0
            --max-instances=2
            --allow-unauthenticated
            --description="Deployed from GitHub Actions - ${{ github.sha }}"
          env_vars: |
            OPENAI_API_KEY_SEDOKU=${{ secrets.OPENAI_API_KEY_SEDOKU }}
